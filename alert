import pandas as pd
from pyzabbix import ZabbixAPI, ZabbixAPIException
from datetime import datetime, timedelta

# Zabbix API connection details
zabbix_url = 'http://your-zabbix-server.com/zabbix'
zabbix_user = 'your-username'
zabbix_password = 'your-password'

# Host groups to retrieve data for
host_groups = ['abc', 'def', 'ghi']

# Initialize Zabbix API
zapi = ZabbixAPI(zabbix_url)
zapi.login(zabbix_user, zabbix_password)

# Function to get recent problems for a host group
def get_recent_problems(host_group):
    group_id = zapi.hostgroup.get(filter={'name': host_group})[0]['groupid']
    
    # Set the time range (problems less than 1 day old)
    since_time = int((datetime.now() - timedelta(days=1)).timestamp())
    
    # Get recent problems
    problems = zapi.problem.get(
        filter={'groups': [{'groupid': group_id}]},
        selectAcknowledges='extend',
        selectHosts=['host'],
        selectTags=['tag', 'value'],
        sortfield='eventid',
        sortorder='DESC',
        time_from=since_time
    )
    
    return problems

# Function to format and export data to Excel
def export_to_excel(data):
    df = pd.DataFrame(data)
    df = df.pivot_table(index='host_group', columns='severity', values='count', fill_value=0)
    df = df[['Not classified', 'Information', 'Warning', 'Minor', 'Major', 'Critical']]
    df.to_excel('zabbix_problems.xlsx', index=True)

# Main script
result_data = []

for host_group in host_groups:
    problems = get_recent_problems(host_group)
    
    # Count problems by severity
    problem_count = {'host_group': host_group, 'Not classified': 0, 'Information': 0, 'Warning': 0, 'Minor': 0, 'Major': 0, 'Critical': 0}
    
    for problem in problems:
        severity = problem['severity']
        problem_count[severity] += 1
    
    result_data.append(problem_count)

# Export data to Excel
export_to_excel(result_data)

# Logout from Zabbix API
zapi.user.logout()
