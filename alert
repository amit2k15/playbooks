import pyzabbix
import datetime
import openpyxl

# Zabbix connection details
ZABBIX_URL = "http://your-zabbix-server/zabbix"
ZABBIX_USER = "your-username"
ZABBIX_PASSWORD = "your-password"

# Host groups to fetch data for
HOST_GROUPS = ["abc", "def", "ghi"]

# Connect to Zabbix API
zapi = pyzabbix.ZabbixAPI(ZABBIX_URL)
zapi.login(ZABBIX_USER, ZABBIX_PASSWORD)

# Function to fetch problem count for a host group
def get_problem_count(host_group):
    params = {
        "groupids": host_group,
        "selectHosts": "extend",
        "output": "extend",
        "filter": {
            "eventid": "1",  # Filter for problems
            "value": 1,     # Filter for active problems
            "time_from": (datetime.datetime.now() - datetime.timedelta(days=1)).strftime("%Y-%m-%d %H:%M:%S"),
            "sortfield": "eventid",
            "sortorder": "DESC"
        }
    }
    problems = zapi.problem.get(**params)

    severity_counts = {
        "Not classified": 0,
        "Information": 0,
        "Warning": 0,
        "Minor": 0,
        "Major": 0,
        "Critical": 0
    }

    for problem in problems:
        severity = problem["severity"]
        severity_counts[severity] += 1

    return severity_counts

# Create Excel workbook and worksheet
workbook = openpyxl.Workbook()
worksheet = workbook.active

# Write header row
worksheet.append(["Host Group", "Not classified", "Information", "Warning", "Minor", "Major", "Critical"])

# Fetch and write data for each host group
for host_group in HOST_GROUPS:
    severity_counts = get_problem_count(host_group)
    worksheet.append([host_group] + list(severity_counts.values()))

# Save Excel file
workbook.save("zabbix_problem_counts.xlsx")
