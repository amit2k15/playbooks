import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from datetime import datetime
import openpyxl
from pyzabbix import ZabbixAPI

# Zabbix server information
zabbix_server = 'Zabbix URL'
zabbix_user = 'api'
zabbix_password = 'api@123'

# Host group name
host_group_name = 'VDI'

# Connect to Zabbix API
zabbix = ZabbixAPI(zabbix_server)
zabbix.login(zabbix_user, zabbix_password)

# Get host group ID
host_group = zabbix.hostgroup.get(filter={'name': host_group_name})
host_group_id = host_group[0]['groupid']

# Get hosts in the specified host group
hosts = zabbix.host.get(groupids=host_group_id, output=['hostid', 'host'])

# Create email content
email_content = "Hi Team,<br>Please find the attached report on OWCA VDI Servers Zabbix report.</br>"
email_content += "<table border='1'><tr><th>Host</th><th>Uptime(In Days)</th><th>CPU CORE</th><th>Tanium Client Service</th><th>Disk Utilization%</th></tr>"

# Iterate through hosts
for host in hosts:
    host_id = host['hostid']
    host_name = host['host']

    # Get CPU Utilization
    cpu_core = zabbix.item.get(hostids=host_id, search={'key_': 'wmi.get[root/cimv2,"Select NumberOfLogicalProcessors from Win32_ComputerSystem"]'}, output=['lastvalue'])[0]['lastvalue']
    #cpu_core = round(float(cpu_util), 2) if cpu_util else None

    # Get Tanium Client
    tanium_client = zabbix.item.get(hostids=host_id, search={'key_': 'service.info["Tanium Client",state]'}, output=['lastvalue'])[0]['lastvalue']
    #memory_util = round(float(memory_util), 2) if memory_util else None

    # Get Queue
    #queue = zabbix.item.get(hostids=host_id, search={'key_': 'zabbix[queue,10m]'}, output=['lastvalue'])[0]['lastvalue']

    # Get Uptime
    uptime_seconds = zabbix.item.get(hostids=host_id, search={'key_': 'system.uptime'}, output=['lastvalue'])[0]['lastvalue']
    uptime_days = round(float(uptime_seconds) / (24 * 60 * 60), 2) if uptime_seconds else None

    # Get Disk Utilization
    disk_utilization_c = zabbix.item.get(hostids=host_id, search={'key_': 'perf_counter_en["\PhysicalDisk(0 C:)\% Disk Time",60]'}, output=['lastvalue'])[0]['lastvalue']
    disk_utilization_c = round(float(disk_utilization_c),2) if disk_utilization_c else None

    # Calculate Last Seen in seconds
   #current_time_seconds = datetime.now().timestamp()
    #last_seen_difference = round(current_time_seconds - last_seen_seconds,2) if last_seen_seconds else None

    # Append data to the email content
    email_content += f"<tr><td>{host_name}</td><td>{uptime_days}</td><td>{cpu_core}</td><td>{tanium_client}</td><td>{disk_utilization_c}</td></tr>"

# Close the HTML table
email_content += "</table>"

email_content += "<br>Regards,</br>ORx-Zabbix Team, OptumRx<br></br><br>*** This is an automatically generated email â€“ please do not reply to it. If you have any queries regarding the report please email to orx_zabbix_support@ds.uhc.com ***</br>"

# Logout from Zabbix API
zabbix.user.logout()

# Sending email using smtplib
from_email = 'zabbix@optum.com'
to_email = 'amit_nayak@optum.com'
smtp_server = 'mailo2.uhc.com'
subject = f'OWCA-VDI Zabbix Report {datetime.now().strftime("%Y-%m-%d")}'

msg = MIMEMultipart()
msg['From'] = from_email
msg['To'] = to_email
msg['Subject'] = subject
msg.attach(MIMEText(email_content, 'html'))

# Connect to the SMTP server and send the email
with smtplib.SMTP(smtp_server) as server:
    server.sendmail(from_email, to_email, msg.as_string())

print(f'Email with OWCA-VDI Report sent to {to_email}')

# Get Disk Utilization for last 24 hours
    disk_utilization_items = zabbix.item.get(hostids=host_id, search={'key_': 'perf_counter_en["\PhysicalDisk(0 C:)\% Disk Time",60]'}, output=['itemid'])[0]['itemid']
    time_till = int(datetime.now().timestamp())
    time_from = int((datetime.now() - timedelta(days=1)).timestamp())

    disk_utilization_history = zabbix.history.get(itemids=disk_utilization_items, time_from=time_from, time_till=time_till, output='extend')

    disk_utilization_sum = sum(float(item['value']) for item in disk_utilization_history) if disk_utilization_history else 0
    average_disk_utilization = disk_utilization_sum / len(disk_utilization_history) if disk_utilization_history else 0
# Append data to the email content
    email_content += f"<tr><td>{host_name}</td><td>{uptime_days}</td><td>{cpu_core}</td><td>{tanium_client}</td><td>{average_disk_utilization:.2f}</td></tr>"
