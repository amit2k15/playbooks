from pyzabbix.api import ZabbixAPI
from openpyxl import Workbook

# Zabbix API details
url = "http://<your_zabbix_server_url>/api/jsonrpc.php"
username = "<your_username>"
password = "<your_password>"

# Filter for OWCA host groups and Red state
hostgroup_filter = {"name": {"like": "OWCA"}}
filter_ = {"status": "1"}  # 1 represents Red state

# Connect to Zabbix API
zapi = ZabbixAPI(url=url, user=username, password=password)

# Get host groups containing OWCA
hostgroups = zapi.hostgroup.get(filter=hostgroup_filter)

# Initialize empty list for results
results = []

# Loop through each host group
for group in hostgroups:
    group_id = group["groupid"]

    # Get hosts in the current group
    hosts = zapi.host.get(groupids=[group_id], output=["hostid", "name"])

    # Loop through each host
    for host in hosts:
        host_id = host["hostid"]

        # Get host details with SNMP status
        host_details = zapi.host.get(hostids=[host_id], select_interfaces=["snmp_agent_status"])

        # Check if SNMP status is Red (problem)
        if host_details[0]["interfaces"][0]["snmp_agent_status"] == 3:  # 3 represents problem
            results.append({"host": host["name"], "hostgroup": group["name"], "status": "Red"})

# Create a new Excel workbook
wb = Workbook()
ws = wb.active
ws.title = "Zabbix SNMP Status (OWCA Host Groups)"

# Set headers
ws.cell(row=1, column=1).value = "Host"
ws.cell(row=1, column=2).value = "Host Group"
ws.cell(row=1, column=3).value = "Status"

# Add results to the sheet
row = 2
for item in results:
    ws.cell(row=row, column=1).value = item["host"]
    ws.cell(row=row, column=2).value = item["hostgroup"]
    ws.cell(row=row, column=3).value = item["status"]
    row += 1

# Save the Excel sheet
wb.save("zabbix_snmp_status_owca.xlsx")

print("Successfully retrieved SNMP status for OWCA host groups and saved to 'zabbix_snmp_status_owca.xlsx'")
