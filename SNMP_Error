import openpyxl
from pyzabbix import ZabbixAPI

# Zabbix API connection details
ZABBIX_SERVER = 'https://your_zabbix_server_url'
USERNAME = 'your_username'
PASSWORD = 'your_password'

# Initialize Zabbix API connection
zapi = ZabbixAPI(ZABBIX_SERVER)
zapi.login(USERNAME, PASSWORD)

# Retrieve host groups containing 'OWCA'
host_groups = zapi.hostgroup.get(filter={"name": "OWCA"}, output=["groupid", "name"])

# Retrieve hosts with SNMP errors
hosts_with_errors = []
for group in host_groups:
    hosts = zapi.host.get(groupids=group['groupid'], output=["hostid", "host", "name"], selectInterfaces=["type", "snmp_error"])
    for host in hosts:
        for interface in host.get('interfaces', []):
            if interface['type'] == '2' and interface.get('snmp_error'):  # type 2 is SNMP
                hosts_with_errors.append({
                    'Host': host['host'],
                    'Host Name': host['name'],
                    'Host Group': group['name'],
                    'SNMP Error': interface['snmp_error']
                })

# Create an Excel workbook and sheet
wb = openpyxl.Workbook()
ws = wb.active
ws.title = "SNMP Errors"

# Write headers
headers = ['Host', 'Host Name', 'Host Group', 'SNMP Error']
ws.append(headers)

# Write host data
for host in hosts_with_errors:
    ws.append([host['Host'], host['Host Name'], host['Host Group'], host['SNMP Error']])

# Save the workbook
wb.save('hosts_with_snmp_errors.xlsx')

print(f"Data has been saved to 'hosts_with_snmp_errors.xlsx'")

# Logout from Zabbix API
zapi.logout()
