from pyzabbix.api import ZabbixAPI
from openpyxl import Workbook

# Zabbix API details
url = "http://your_zabbix_server/api/jsonrpc.php"  # Replace with your Zabbix URL
username = "your_username"
password = "your_password"

# Filter parameters
hostgroup_name_filter = "OWCA"
snmp_status = "1"  # Red state in Zabbix

# Connect to Zabbix API
zapi = ZabbixAPI(url=url, user=username, password=password)

# Get hostgroup ID by name
hostgroups = zapi.hostgroup.get(filter={"name": hostgroup_name_filter})

# Check if any hostgroup found
if not hostgroups:
    print(f"No hostgroup found with name '{hostgroup_name_filter}'")
    exit()

hostgroup_id = hostgroups[0]["groupid"]

# Get hosts with SNMP in Red state
filters = {
    "groupids": hostgroup_id,
    "filter": {"status": snmp_status},
    "output": ["hostid", "name", "hostgroups"],
}

hosts = zapi.host.get(**filters)

# Create Excel workbook
wb = Workbook()
ws = wb.active
ws.title = f"OWCA Hosts with SNMP in Red State"

# Set column headers
ws.append(["Hostname", "Host Group", "Status"])

# Populate data in Excel sheet
for host in hosts:
    host_name = host["name"]
    host_groups = ", ".join([group["name"] for group in host["hostgroups"]])
    status = "Red"  # Assuming status is derived from snmp_status

    ws.append([host_name, host_groups, status])

# Save the Excel sheet
wb.save("owca_snmp_red_hosts.xlsx")

print(f"Data saved to owca_snmp_red_hosts.xlsx")
