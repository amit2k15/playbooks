import requests
from datetime import datetime, timedelta
from openpyxl import Workbook

# Zabbix API settings
zabbix_url = 'http://your_zabbix_server/zabbix/api_jsonrpc.php'
zabbix_user = 'your_zabbix_username'
zabbix_password = 'your_zabbix_password'

# Host group and item keys
host_group_name = 'YourHostGroupName'
item_keys = {
    'CPU': 'system.cpu.util',
    'Memory': 'vm.memory.utilization',
    'Queue': 'zabbix[queue,10m]',
    'Uptime': 'system.uptime',
    'LastSeen': 'zabbix[proxy,{HOST.HOST},lastaccess]'
}

# Calculate last seen time
current_time = datetime.now()
time_threshold = current_time - timedelta(hours=1)  # Change the threshold as needed

# Zabbix API authentication
auth_data = {
    'jsonrpc': '2.0',
    'method': 'user.login',
    'params': {
        'user': zabbix_user,
        'password': zabbix_password
    },
    'id': 1
}

response = requests.post(zabbix_url, json=auth_data)
auth_result = response.json()

if 'error' in auth_result:
    print(f"Zabbix authentication failed: {auth_result['error']['data']}")
    exit()

auth_token = auth_result['result']

# Get host group ID
get_group_data = {
    'jsonrpc': '2.0',
    'method': 'hostgroup.get',
    'params': {
        'output': 'extend',
        'filter': {'name': host_group_name}
    },
    'auth': auth_token,
    'id': 1
}

response = requests.post(zabbix_url, json=get_group_data)
group_result = response.json()

if not group_result['result']:
    print(f"Host group '{host_group_name}' not found.")
    exit()

group_id = group_result['result'][0]['groupid']

# Get hosts in the host group
get_hosts_data = {
    'jsonrpc': '2.0',
    'method': 'host.get',
    'params': {
        'output': 'extend',
        'groupids': group_id,
        'selectInterfaces': ['host']
    },
    'auth': auth_token,
    'id': 1
}

response = requests.post(zabbix_url, json=get_hosts_data)
hosts_result = response.json()

if not hosts_result['result']:
    print(f"No hosts found in the group '{host_group_name}'.")
    exit()

# Create Excel workbook and sheet
wb = Workbook()
ws = wb.active
ws.append(['Host', 'CPU', 'Memory', 'Queue', 'Uptime', 'Last Seen'])

# Fetch item data for each host
for host in hosts_result['result']:
    host_name = host['host']
    host_id = host['hostid']

    item_data = {
        'jsonrpc': '2.0',
        'method': 'item.get',
        'params': {
            'output': 'extend',
            'hostids': host_id,
            'search': {'key_': list(item_keys.values())}
        },
        'auth': auth_token,
        'id': 1
    }

    response = requests.post(zabbix_url, json=item_data)
    item_result = response.json()

    if 'result' in item_result and item_result['result']:
        item_values = {key: None for key in item_keys}
        for item in item_result['result']:
            key = item['key_']
            value = item['lastvalue']
            item_values[key] = value

        # Check if the last seen time is within the threshold
        last_seen_str = item_values['zabbix[proxy,{HOST.HOST},lastaccess]']
        last_seen_time = datetime.fromtimestamp(int(last_seen_str))
        if last_seen_time >= time_threshold:
            ws.append([host_name, item_values['system.cpu.util'], item_values['vm.memory.utilization'],
                       item_values['zabbix[queue,10m]'], item_values['system.uptime'], last_seen_time])

# Save the Excel file
wb.save('zabbix_data.xlsx')

print("Data has been fetched and saved to 'zabbix_data.xlsx'.")
