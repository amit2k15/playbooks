import requests
from requests.auth import HTTPBasicAuth
from openpyxl import Workbook
from datetime import datetime

# Zabbix API details
zabbix_url = 'http://your-zabbix-instance/api_jsonrpc.php'
zabbix_user = 'your-username'
zabbix_password = 'your-password'

# Zabbix API authentication
auth = HTTPBasicAuth(zabbix_user, zabbix_password)

# Function to get Zabbix proxy last seen information
def get_proxy_last_seen(zabbix_url, auth):
    # Zabbix API request payload for proxy.get method
    payload = {
        'jsonrpc': '2.0',
        'method': 'proxy.get',
        'params': {
            'output': ['host', 'lastaccess'],
            'selectInterface': ['ip'],
        },
        'auth': None,
        'id': 1,
    }

    # Sending the request to Zabbix API
    response = requests.post(zabbix_url, json=payload, auth=auth)

    # Handling the response
    if response.status_code == 200:
        data = response.json()
        proxies = data.get('result', [])
        return proxies
    else:
        print(f"Error: {response.status_code}, {response.text}")
        return None

# Function to generate Excel file with proxy information
def generate_excel(proxies):
    # Creating a new Excel workbook and selecting the active sheet
    wb = Workbook()
    ws = wb.active

    # Adding headers to the Excel sheet
    ws.append(['Proxy Host', 'Proxy IP', 'Last Seen'])

    # Populating the Excel sheet with proxy information
    for proxy in proxies:
        host = proxy.get('host', '')
        ip = proxy.get('interfaces', [])[0].get('ip', '')
        last_seen_timestamp = proxy.get('lastaccess', 0)
        last_seen = datetime.utcfromtimestamp(last_seen_timestamp).strftime('%Y-%m-%d %H:%M:%S')

        ws.append([host, ip, last_seen])

    # Saving the Excel workbook
    wb.save('zabbix_proxy_info.xlsx')
    print('Excel file generated successfully.')

if __name__ == '__main__':
    proxies = get_proxy_last_seen(zabbix_url, auth)

    if proxies:
        generate_excel(proxies)
