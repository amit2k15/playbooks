import requests
import pandas as pd

# Zabbix API configuration
zabbix_api_url = 'http://your-zabbix-server/zabbix/api_jsonrpc.php'
zabbix_username = 'your-username'
zabbix_password = 'your-password'

# Zabbix item keys
cpu_key = 'system.cpu.util'
memory_key = 'vm.memory.utilization'
queue_key = 'zabbix[queue,10m]'
uptime_key = 'system.uptime'
last_seen_key = 'zabbix[proxy,{HOST.HOST},lastaccess]'

# Zabbix host group
host_group_name = 'YourHostGroupName'

def get_zabbix_api_token(api_url, username, password):
    headers = {'Content-Type': 'application/json'}
    payload = {
        'jsonrpc': '2.0',
        'method': 'user.login',
        'params': {'user': username, 'password': password},
        'id': 1,
    }

    response = requests.post(api_url, json=payload, headers=headers)
    result = response.json()
    return result['result']

def get_host_ids_in_group(api_url, token, group_name):
    headers = {'Content-Type': 'application/json'}
    payload = {
        'jsonrpc': '2.0',
        'method': 'hostgroup.get',
        'params': {'output': 'extend', 'filter': {'name': group_name}},
        'auth': token,
        'id': 1,
    }

    response = requests.post(api_url, json=payload, headers=headers)
    result = response.json()
    if result.get('result'):
        return [host['hostid'] for host in result['result'][0]['hosts']]
    else:
        return []

def get_host_item_value(api_url, token, host_id, item_key):
    headers = {'Content-Type': 'application/json'}
    payload = {
        'jsonrpc': '2.0',
        'method': 'item.get',
        'params': {'output': 'extend', 'hostids': host_id, 'search': {'key_': item_key}},
        'auth': token,
        'id': 1,
    }

    response = requests.post(api_url, json=payload, headers=headers)
    result = response.json()
    if result.get('result'):
        return result['result'][0]['lastvalue']
    else:
        return None

def main():
    # Get Zabbix API token
    token = get_zabbix_api_token(zabbix_api_url, zabbix_username, zabbix_password)

    # Get host ids in the specified host group
    host_ids = get_host_ids_in_group(zabbix_api_url, token, host_group_name)

    # Prepare data for Excel
    data = {
        'Host': [],
        'CPU': [],
        'Memory': [],
        'Queue': [],
        'Uptime': [],
        'Last Seen': [],
    }

    for host_id in host_ids:
        data['Host'].append(host_id)
        data['CPU'].append(get_host_item_value(zabbix_api_url, token, host_id, cpu_key))
        data['Memory'].append(get_host_item_value(zabbix_api_url, token, host_id, memory_key))
        data['Queue'].append(get_host_item_value(zabbix_api_url, token, host_id, queue_key))
        data['Uptime'].append(get_host_item_value(zabbix_api_url, token, host_id, uptime_key))
        data['Last Seen'].append(get_host_item_value(zabbix_api_url, token, host_id, last_seen_key))

    # Create a Pandas DataFrame
    df = pd.DataFrame(data)

    # Save the DataFrame to an Excel file
    excel_filename = 'zabbix_data.xlsx'
    df.to_excel(excel_filename, index=False)
    print(f'Data saved to {excel_filename}')

if __name__ == '__main__':
    main()
