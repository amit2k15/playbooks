import requests
from requests.auth import HTTPBasicAuth
from openpyxl import Workbook
from datetime import datetime

# Zabbix API details
zabbix_url = 'http://your_zabbix_server/api_jsonrpc.php'
zabbix_user = 'your_username'
zabbix_password = 'your_password'

# Function to authenticate and get Zabbix API token
def get_zabbix_token():
    headers = {'Content-Type': 'application/json'}
    data = {
        'jsonrpc': '2.0',
        'method': 'user.login',
        'params': {
            'user': zabbix_user,
            'password': zabbix_password
        },
        'id': 1,
    }

    response = requests.post(zabbix_url, headers=headers, json=data)
    return response.json()['result']

# Function to get Zabbix proxy information
def get_zabbix_proxy_info(token):
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {token}',
    }
    data = {
        'jsonrpc': '2.0',
        'method': 'proxy.get',
        'params': {
            'output': ['proxyid', 'host'],
            'selectInterface': ['ip', 'useip'],
        },
        'id': 1,
    }

    response = requests.post(zabbix_url, headers=headers, json=data)
    return response.json()['result']

# Function to generate Excel file
def generate_excel(proxy_info):
    workbook = Workbook()
    sheet = workbook.active
    sheet.title = 'Zabbix Proxies'

    # Add headers
    headers = ['Proxy ID', 'Proxy Host', 'Last Seen']
    sheet.append(headers)

    for proxy in proxy_info:
        proxy_id = proxy['proxyid']
        proxy_host = proxy['host']
        last_seen = proxy.get('lastaccess', 'N/A')

        sheet.append([proxy_id, proxy_host, last_seen])

    # Save the workbook
    timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
    excel_filename = f'zabbix_proxies_{timestamp}.xlsx'
    workbook.save(excel_filename)
    print(f'Excel file "{excel_filename}" created successfully.')

if __name__ == "__main__":
    # Authenticate and get Zabbix API token
    token = get_zabbix_token()

    # Get Zabbix proxy information
    proxy_info = get_zabbix_proxy_info(token)

    # Generate Excel file
    generate_excel(proxy_info)
