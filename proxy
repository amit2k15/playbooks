import requests
from requests.auth import HTTPBasicAuth
import openpyxl
from openpyxl import Workbook

# Zabbix API credentials and URL
zabbix_url = 'http://your_zabbix_server/api_jsonrpc.php'
zabbix_user = 'your_username'
zabbix_password = 'your_password'

# Zabbix API version
zabbix_api_version = '4.0'  # Change this to match your Zabbix version

# Create a session for API requests
session = requests.Session()
session.auth = HTTPBasicAuth(zabbix_user, zabbix_password)
session.headers.update({'Content-Type': 'application/json'})

def get_zabbix_proxies():
    # Get Zabbix proxies
    data = {
        'jsonrpc': '2.0',
        'method': 'proxy.get',
        'params': {
            'output': 'extend',
            'selectInterface': 'extend',
            'selectHosts': 'extend'
        },
        'auth': None,
        'id': 1
    }

    response = session.post(zabbix_url, json=data)
    proxies = response.json()['result']

    return proxies

def create_excel_file(proxies):
    # Create Excel workbook and sheet
    wb = Workbook()
    ws = wb.active

    # Add headers to the sheet
    headers = ['Proxy Name', 'Last Seen']
    ws.append(headers)

    # Add data to the sheet
    for proxy in proxies:
        proxy_name = proxy['host']
        last_seen = proxy['lastaccess']
        ws.append([proxy_name, last_seen])

    # Save the workbook to a file
    wb.save('zabbix_proxy_last_seen.xlsx')

def main():
    proxies = get_zabbix_proxies()
    create_excel_file(proxies)
    print("Excel file 'zabbix_proxy_last_seen.xlsx' created successfully.")

if __name__ == "__main__":
    main()
