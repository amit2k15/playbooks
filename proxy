import requests
import json

def get_zabbix_proxy_last_seen(zabbix_url, username, password, proxy_name):
    # Zabbix API endpoint
    api_url = f"{zabbix_url}/zabbix/api_jsonrpc.php"

    # Zabbix API authentication payload
    auth_payload = {
        "jsonrpc": "2.0",
        "method": "user.login",
        "params": {
            "user": username,
            "password": password
        },
        "id": 1,
        "auth": None
    }

    # Authenticate and get the authentication token
    response = requests.post(api_url, data=json.dumps(auth_payload), headers={"Content-Type": "application/json"})
    result = response.json()
    auth_token = result["result"]

    # Zabbix API request to get proxy information
    proxy_payload = {
        "jsonrpc": "2.0",
        "method": "proxy.get",
        "params": {
            "output": ["proxyid", "host"],
            "selectInterface": ["ip"],
            "filter": {
                "host": proxy_name
            }
        },
        "id": 2,
        "auth": auth_token
    }

    # Get the proxy information
    response = requests.post(api_url, data=json.dumps(proxy_payload), headers={"Content-Type": "application/json"})
    result = response.json()

    # Check if the proxy was found
    if "result" in result and result["result"]:
        proxy_info = result["result"][0]
        proxy_id = proxy_info["proxyid"]

        # Zabbix API request to get proxy last seen information
        last_seen_payload = {
            "jsonrpc": "2.0",
            "method": "proxy.get",
            "params": {
                "output": "extend",
                "selectInterface": ["ip"],
                "proxyids": proxy_id
            },
            "id": 3,
            "auth": auth_token
        }

        # Get the last seen information for the proxy
        response = requests.post(api_url, data=json.dumps(last_seen_payload), headers={"Content-Type": "application/json"})
        result = response.json()

        if "result" in result and result["result"]:
            last_seen = result["result"][0]["lastaccess"]
            return f"Last seen time for proxy '{proxy_name}': {last_seen}"

    return f"Proxy '{proxy_name}' not found or unable to retrieve last seen information."

if __name__ == "__main__":
    # Replace these values with your Zabbix instance details
    zabbix_url = "http://your_zabbix_server"
    username = "your_username"
    password = "your_password"

    # Replace with the name of the Zabbix proxy you want to check
    proxy_name = "your_proxy_name"

    result = get_zabbix_proxy_last_seen(zabbix_url, username, password, proxy_name)
    print(result)
