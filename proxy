import requests
import openpyxl
from requests.auth import HTTPBasicAuth

# Zabbix API URL
zabbix_api_url = 'http://your_zabbix_server/api_jsonrpc.php'

# Zabbix API credentials
username = 'your_username'
password = 'your_password'

# Function to authenticate and get Zabbix API token
def get_zabbix_api_token():
    headers = {'Content-Type': 'application/json'}
    data = {
        'jsonrpc': '2.0',
        'method': 'user.login',
        'params': {
            'user': username,
            'password': password
        },
        'id': 1
    }

    response = requests.post(zabbix_api_url, json=data, headers=headers)
    result = response.json()

    if 'result' in result:
        return result['result']
    else:
        raise Exception(f"Failed to authenticate: {result['error']['data']}")

# Function to get Zabbix proxy information
def get_zabbix_proxy_info(token):
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {token}'
    }
    data = {
        'jsonrpc': '2.0',
        'method': 'proxy.get',
        'params': {
            'output': ['host', 'lastaccess']
        },
        'id': 2
    }

    response = requests.post(zabbix_api_url, json=data, headers=headers)
    result = response.json()

    if 'result' in result:
        return result['result']
    else:
        raise Exception(f"Failed to get proxy information: {result['error']['data']}")

# Function to generate Excel file
def generate_excel(proxy_info):
    workbook = openpyxl.Workbook()
    sheet = workbook.active
    sheet.title = 'Zabbix Proxies'

    # Write headers
    sheet['A1'] = 'Proxy Host'
    sheet['B1'] = 'Last Seen'

    # Write proxy information
    for index, proxy in enumerate(proxy_info, start=2):
        sheet.cell(row=index, column=1, value=proxy['host'])
        sheet.cell(row=index, column=2, value=proxy['lastaccess'])

    # Save the Excel file
    workbook.save('zabbix_proxies.xlsx')

if __name__ == "__main__":
    try:
        # Get Zabbix API token
        token = get_zabbix_api_token()

        # Get Zabbix proxy information
        proxy_info = get_zabbix_proxy_info(token)

        # Generate Excel file
        generate_excel(proxy_info)

        print("Excel file generated successfully.")
    except Exception as e:
        print(f"Error: {e}")
