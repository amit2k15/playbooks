import requests
from openpyxl import Workbook

# Zabbix API configuration
zabbix_url = "http://your-zabbix-server/api_jsonrpc.php"
zabbix_user = "your-zabbix-username"
zabbix_password = "your-zabbix-password"

# Specify the host group name you are interested in
host_group_name = "YourHostGroupName"

# Zabbix item keys
item_keys = {
    "CPU": "system.cpu.util",
    "Memory": "vm.memory.utilization",
    "Queue": "zabbix[queue,10m]",
    "Uptime": "system.uptime",
    "Last Seen": "zabbix[proxy,{HOST.HOST},lastaccess]"
}

def get_zabbix_data(host_id, item_key):
    data = {
        "jsonrpc": "2.0",
        "method": "item.get",
        "params": {
            "output": ["lastvalue"],
            "hostids": host_id,
            "search": {"key_": item_key}
        },
        "auth": zabbix_auth_token,
        "id": 1
    }

    response = requests.post(zabbix_url, json=data)
    result = response.json()["result"]
    return result[0]["lastvalue"] if result else None

# Authenticate and get the Zabbix API token
auth_data = {
    "jsonrpc": "2.0",
    "method": "user.login",
    "params": {
        "user": zabbix_user,
        "password": zabbix_password
    },
    "id": 1,
}

response = requests.post(zabbix_url, json=auth_data)
zabbix_auth_token = response.json()["result"]

# Get host group ID
get_hostgroup_data = {
    "jsonrpc": "2.0",
    "method": "hostgroup.get",
    "params": {
        "output": "extend",
        "filter": {"name": [host_group_name]}
    },
    "auth": zabbix_auth_token,
    "id": 1
}

response = requests.post(zabbix_url, json=get_hostgroup_data)
host_group_id = response.json()["result"][0]["groupid"]

# Get hosts in the specified host group
get_hosts_data = {
    "jsonrpc": "2.0",
    "method": "host.get",
    "params": {
        "output": ["hostid", "name"],
        "groupids": host_group_id
    },
    "auth": zabbix_auth_token,
    "id": 1
}

response = requests.post(zabbix_url, json=get_hosts_data)
hosts = response.json()["result"]

# Create an Excel workbook and add a worksheet
workbook = Workbook()
worksheet = workbook.active

# Write headers
headers = ["Host", "CPU", "Memory", "Queue", "Uptime", "Last Seen"]
worksheet.append(headers)

# Fetch and write data for each host
for host in hosts:
    host_id = host["hostid"]
    row_data = [host["name"]]
    for key in headers[1:]:
        item_key = item_keys[key]
        value = get_zabbix_data(host_id, item_key)
        row_data.append(value)
    worksheet.append(row_data)

# Save the workbook to a file
excel_file = "zabbix_data.xlsx"
workbook.save(excel_file)

print(f"Zabbix data saved to {excel_file}")
