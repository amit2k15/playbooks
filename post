import pandas as pd
from pyzabbix import ZabbixAPI

# Define your Zabbix server URL and credentials
ZABBIX_SERVER = 'https://your_zabbix_server_url'
USERNAME = 'your_username'
PASSWORD = 'your_password'
HOST_GROUP_NAME = 'Your_Host_Group_Name'

# Initialize the Zabbix API connection
zapi = ZabbixAPI(ZABBIX_SERVER)
zapi.login(USERNAME, PASSWORD)

# Get host group ID
host_groups = zapi.hostgroup.get(filter={"name": HOST_GROUP_NAME})
if not host_groups:
    print(f"Host group '{HOST_GROUP_NAME}' not found.")
    exit()

host_group_id = host_groups[0]['groupid']

# Get hosts in the specified host group
hosts = zapi.host.get(groupids=host_group_id, output=['hostid', 'host', 'status'])

# Prepare data storage
data = []

for host in hosts:
    host_id = host['hostid']
    host_name = host['host']
    host_status = 'Enabled' if host['status'] == '0' else 'Disabled'
    
    # Get items for each host, excluding templateid 10081
    items = zapi.item.get(hostids=host_id, filter={"templateid": "0"}, output=['name', 'status', 'delay', 'params'])
    
    for item in items:
        item_name = item['name']
        item_status = 'Enabled' if item['status'] == '0' else 'Disabled'
        item_delay = item['delay']
        item_params = item['params']

        # Get triggers for each item
        triggers = zapi.trigger.get(itemids=item['itemid'], output=['description', 'status', 'priority'])

        for trigger in triggers:
            trigger_name = trigger['description']
            trigger_status = 'Enabled' if trigger['status'] == '0' else 'Disabled'
            trigger_severity = trigger['priority']

            # Add data to the list
            data.append({
                'Host Name': host_name,
                'Host Status': host_status,
                'Item Name': item_name,
                'Item Params': item_params,
                'Item Status': item_status,
                'Delay': item_delay,
                'Trigger Name': trigger_name,
                'Trigger Status': trigger_status,
                'Trigger Severity': trigger_severity
            })

# Convert data to a pandas DataFrame
df = pd.DataFrame(data)

# Save the DataFrame to an Excel file
df.to_excel('zabbix_report.xlsx', index=False)

print("Report has been saved to 'zabbix_report.xlsx'.")
