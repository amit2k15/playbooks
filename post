from pyzabbix import ZabbixAPI
import pandas as pd
from openpyxl import Workbook

# Replace with your Zabbix server details
ZABBIX_SERVER = 'https://your_zabbix_server'
USERNAME = 'your_username'
PASSWORD = 'your_password'
HOST_GROUP_NAME = 'your_host_group_name'

# Connect to the Zabbix server
zapi = ZabbixAPI(ZABBIX_SERVER)
zapi.login(USERNAME, PASSWORD)

# Get the host group ID
host_group = zapi.hostgroup.get(filter={"name": HOST_GROUP_NAME})
if not host_group:
    print(f"No host group found with the name {HOST_GROUP_NAME}")
    exit()

host_group_id = host_group[0]['groupid']

# Get the hosts in the host group
hosts = zapi.host.get(groupids=host_group_id, selectItems='extend', selectTriggers='extend', selectApplications='extend')

data = []

for host in hosts:
    host_id = host['hostid']
    host_name = host['host']
    host_status = 'Enabled' if host['status'] == '0' else 'Disabled'
    
    # Get the items for each host
    items = zapi.item.get(hostids=host_id, output=['name', 'key_', 'delay', 'status'])
    for item in items:
        item_name = item['name']
        item_details = item['key_']
        item_interval = item['delay']
        item_status = 'Enabled' if item['status'] == '0' else 'Disabled'
        
        # Get the triggers for each item
        triggers = zapi.trigger.get(itemids=item['itemid'], output=['description', 'priority', 'status'])
        for trigger in triggers:
            trigger_severity = trigger['priority']
            trigger_status = 'Enabled' if trigger['status'] == '0' else 'Disabled'
            
            # Get the actions for each trigger
            actions = zapi.action.get(triggerids=trigger['triggerid'], output=['name', 'eventsource'])
            for action in actions:
                action_type = action['eventsource']
                
                # Get the media for each action
                media = zapi.mediatype.get(actionids=action['actionid'], output='extend')
                for m in media:
                    media_type = m['description']
                    data.append([host_name, host_status, item_name, item_details, item_interval, item_status, trigger_severity, trigger_status, action_type, media_type])

# Create a DataFrame
df = pd.DataFrame(data, columns=['Host Name', 'Host Status', 'Item Name', 'Item Details', 'Item Interval', 'Item Status', 'Trigger Severity', 'Trigger Status', 'Action Type', 'Media'])

# Save the DataFrame to an Excel file
df.to_excel('zabbix_data.xlsx', index=False)

print("Data saved to zabbix_data.xlsx")
