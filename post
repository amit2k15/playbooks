from pyzabbix import ZabbixAPI
import pandas as pd

# Connect to Zabbix API
zabbix_url = "http://your_zabbix_server_url/zabbix"
zabbix_user = "your_username"
zabbix_password = "your_password"

zapi = ZabbixAPI(zabbix_url)
zapi.login(zabbix_user, zabbix_password)

# Function to get the host group ID by name
def get_hostgroup_id(hostgroup_name):
    hostgroups = zapi.hostgroup.get(output=["groupid", "name"])
    for hostgroup in hostgroups:
        if hostgroup['name'] == hostgroup_name:
            return hostgroup['groupid']
    return None

# Function to get host data for a specific host group
def get_hosts_data(hostgroup_id):
    hosts_data = []
    hosts = zapi.host.get(groupids=hostgroup_id, output=["hostid", "name", "status"])
    for host in hosts:
        host_id = host["hostid"]
        items = zapi.item.get(hostids=host_id, output=["itemid", "name", "status", "params", "delay"])
        triggers = zapi.trigger.get(hostids=host_id, output=["triggerid", "description", "status", "priority"])
        
        for item in items:
            for trigger in triggers:
                hosts_data.append({
                    "Host Name": host["name"],
                    "Host Status": "Enabled" if host["status"] == "0" else "Disabled",
                    "Item Name": item["name"],
                    "Item Params": item.get("params", ""),
                    "Item Status": "Enabled" if item["status"] == "0" else "Disabled",
                    "Delay": item["delay"],
                    "Trigger Name": trigger["description"],
                    "Trigger Status": "Enabled" if trigger["status"] == "0" else "Disabled",
                    "Trigger Severity": trigger["priority"]
                })
    return hosts_data

# Main function to create the Excel report
def create_excel_report(hostgroup_name, output_file):
    hostgroup_id = get_hostgroup_id(hostgroup_name)
    if not hostgroup_id:
        print(f"Host group '{hostgroup_name}' not found.")
        return
    
    hosts_data = get_hosts_data(hostgroup_id)
    df = pd.DataFrame(hosts_data)
    df.to_excel(output_file, index=False)
    print(f"Report saved to {output_file}")

# Example usage
hostgroup_name = "Your Host Group Name"
output_file = "zabbix_report.xlsx"
create_excel_report(hostgroup_name, output_file)
