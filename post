from pyzabbix import ZabbixAPI
import pandas as pd

# Connect to the Zabbix API
zapi = ZabbixAPI("http://your_zabbix_server_url")
zapi.login("your_username", "your_password")

# Define host group name
host_group_name = "Your Host Group Name"

# Retrieve host group ID
host_group = zapi.hostgroup.get(filter={"name": host_group_name})
if not host_group:
    print(f"Host group '{host_group_name}' not found.")
    exit()
host_group_id = host_group[0]["groupid"]

# Retrieve hosts in the host group
hosts = zapi.host.get(groupids=host_group_id, output=["hostid", "name", "status"])

# Define severity mapping
severity_mapping = {
    '4': 'Major',
    '3': 'Warning',
    '2': 'Minor',
    '1': 'Information'
}

data = []

# Retrieve data for each host
for host in hosts:
    host_id = host["hostid"]
    host_name = host["name"]
    host_status = "Enabled" if host["status"] == "0" else "Disabled"
    
    # Retrieve items for the host, filtering out inherited items
    items = zapi.item.get(
        hostids=host_id,
        output=["name", "status", "delay"],
        filter={"templateid": "0"}
    )
    
    for item in items:
        item_name = item["name"]
        item_status = "Enabled" if item["status"] == "0" else "Disabled"
        item_interval = item["delay"]
        
        # Retrieve triggers for the item
        triggers = zapi.trigger.get(
            hostids=host_id,
            output=["description", "priority", "status"],
            itemids=item["itemid"]
        )
        
        for trigger in triggers:
            trigger_severity = severity_mapping.get(trigger["priority"], "Unknown")
            trigger_status = "Enabled" if trigger["status"] == "0" else "Disabled"
            
            # Retrieve actions for the trigger
            actions = zapi.action.get(
                filter={"triggerid": trigger["triggerid"]},
                output=["name"]
            )
            
            action_names = [action["name"] for action in actions]
            media = ", ".join(action_names)
            
            data.append([
                host_name, host_status, item_name, item_interval, item_status,
                trigger_severity, trigger_status, media
            ])

# Create a DataFrame and save to Excel
df = pd.DataFrame(data, columns=[
    "Host Name", "Host Status", "Item Name", "Item Interval", "Item Status",
    "Trigger Severity", "Trigger Status", "Media"
])

df.to_excel("zabbix_data.xlsx", index=False)
print("Data has been exported to zabbix_data.xlsx")
