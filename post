from pyzabbix import ZabbixAPI
import pandas as pd

# Zabbix server details
zabbix_url = 'http://your-zabbix-server-url'
zabbix_user = 'your-username'
zabbix_password = 'your-password'

# Connect to Zabbix API
zapi = ZabbixAPI(zabbix_url)
zapi.login(zabbix_user, zabbix_password)

# Host group name
host_group_name = 'your-host-group-name'

# Get host group ID
host_group = zapi.hostgroup.get(filter={"name": host_group_name})
if not host_group:
    raise ValueError(f"Host group '{host_group_name}' not found")
host_group_id = host_group[0]['groupid']

# Get hosts in the host group
hosts = zapi.host.get(groupids=host_group_id, output=["hostid", "name", "status"])

# Prepare lists to store data
data = []

# Retrieve data for each host
for host in hosts:
    host_id = host['hostid']
    host_name = host['name']
    host_status = "Enabled" if host['status'] == "0" else "Disabled"
    
    # Get items for the host
    items = zapi.item.get(hostids=host_id, output=["name", "status", "delay", "type"], selectTriggers=["triggerid", "description", "priority", "status"])
    for item in items:
        item_name = item['name']
        item_status = "Enabled" if item['status'] == "0" else "Disabled"
        item_delay = item['delay']
        
        # Get triggers for the item
        for trigger in item['triggers']:
            trigger_id = trigger['triggerid']
            trigger_name = trigger['description']
            trigger_status = "Enabled" if trigger['status'] == "0" else "Disabled"
            trigger_severity = trigger['priority']
            
            # Get web scenarios and database monitors
            web_scenarios = zapi.httptest.get(hostids=host_id, output=["name", "status"], selectSteps=["url", "delay"])
            db_monitors = zapi.db.odbc.query.get(hostids=host_id, output=["name", "sql", "interval"])
            
            for scenario in web_scenarios:
                web_scenario_name = scenario['name']
                web_scenario_status = "Enabled" if scenario['status'] == "0" else "Disabled"
                
                for step in scenario['steps']:
                    url = step['url']
                    step_delay = step['delay']
                    
                    data.append([
                        host_name, host_status, item_name, item_status, item_delay, 
                        web_scenario_name, web_scenario_status, url, step_delay, 
                        trigger_name, trigger_status, trigger_severity, "", ""
                    ])
            
            for monitor in db_monitors:
                db_monitor_name = monitor['name']
                db_monitor_query = monitor['sql']
                db_monitor_interval = monitor['interval']
                
                data.append([
                    host_name, host_status, item_name, item_status, item_delay, 
                    "", "", "", "", 
                    trigger_name, trigger_status, trigger_severity, db_monitor_query, db_monitor_interval
                ])

# Create a DataFrame and save to an Excel file
columns = [
    "Host Name", "Host Status", "Item Name", "Item Status", "Item Delay",
    "Web Scenario Name", "Web Scenario Status", "URL", "Web Scenario Delay",
    "Trigger Name", "Trigger Status", "Trigger Severity", "Database Monitor SQL Query", "Interval"
]
df = pd.DataFrame(data, columns=columns)
df.to_excel("zabbix_report.xlsx", index=False)

print("Report saved to zabbix_report.xlsx")
