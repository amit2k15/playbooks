import openpyxl
from pyzabbix import ZabbixAPI

# Zabbix API connection details
zabbix_server_url = "http://your_zabbix_server/zabbix/"
zabbix_username = "your_username"
zabbix_password = "your_password"

# Host group details (replace with your group ID)
host_group_id = 1

# Template ID to exclude items from (replace with desired ID)
template_id_to_exclude = 10081

# Create a new Excel workbook
wb = openpyxl.Workbook()
ws = wb.active
ws.title = "Zabbix Host Group Report (Excluding Template ID {})".format(template_id_to_exclude)

# Define column headers
headers = ["Host Name", "Host Status", "Item Name", "Item Params", "Item Status", "Delay", "Trigger Name", "Trigger Status", "Trigger Severity"]
ws.append(headers)

# Connect to Zabbix API
zapi = ZabbixAPI(zabbix_server_url, user=zabbix_username, password=zabbix_password)

# Get host group information
host_group = zapi.hostgroup.get(filter={"groupid": host_group_id})[0]
host_group_name = host_group["name"]

# Get hosts in the specified group
hosts = zapi.host.get(filter={"groupids": host_group_id}, select_items=["hostid", "name", "status"])

# Loop through each host
for host in hosts:
    host_id = host["hostid"]
    host_name = host["name"]
    host_status = host["status"]

    # Get items for the current host
    items = zapi.item.get(hostids=host_id, select_triggers=["triggerid", "name", "status", "severity"], output=["hostid", "name", "key", "params", "status", "lasterror"])

    # Filter items to exclude those from the specified template
    filtered_items = [item for item in items if item["templateid"] != template_id_to_exclude]

    # Loop through each filtered item
    for item in filtered_items:
        item_name = item["name"]
        item_params = item["params"]
        item_status = item["status"]
        item_delay = item.get("delay", "N/A")  # Handle potential absence of "delay" key

        # Get trigger information for the item
        triggers = item["triggers"]
        for trigger in triggers:
            trigger_name = trigger["name"]
            trigger_status = trigger["status"]
            trigger_severity = trigger["severity"]

            # Write data to the Excel sheet
            data_row = [host_name, host_status, item_name, item_params, item_status, item_delay, trigger_name, trigger_status, trigger_severity]
            ws.append(data_row)

# Save the Excel report
report_filename = "Zabbix_Host_Group_Report_{}.xlsx".format(host_group_name)
wb.save(filename=report_filename)

print("Zabbix Host Group Report generated successfully! Saved as:", report_filename)
