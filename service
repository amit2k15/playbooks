import requests
import json
from openpyxl import Workbook

# Zabbix API credentials
zabbix_url = 'http://your_zabbix_server/zabbix/api_jsonrpc.php'
zabbix_username = 'your_username'
zabbix_password = 'your_password'

# Zabbix API authentication
def authenticate():
    headers = {'Content-Type': 'application/json'}
    payload = {
        'jsonrpc': '2.0',
        'method': 'user.login',
        'params': {
            'user': zabbix_username,
            'password': zabbix_password
        },
        'id': 1,
        'auth': None
    }
    response = requests.post(zabbix_url, data=json.dumps(payload), headers=headers)
    result = response.json()
    return result['result']

# Get host IDs in a specific host group
def get_host_ids(group_name):
    headers = {'Content-Type': 'application/json'}
    auth_token = authenticate()
    payload = {
        'jsonrpc': '2.0',
        'method': 'hostgroup.get',
        'params': {
            'output': 'extend',
            'filter': {
                'name': group_name
            },
            'selectHosts': 'extend'
        },
        'auth': auth_token,
        'id': 1
    }
    response = requests.post(zabbix_url, data=json.dumps(payload), headers=headers)
    result = response.json()
    return [host['hostid'] for host in result['result'][0]['hosts']]

# Get items for a specific host
def get_items(host_id):
    headers = {'Content-Type': 'application/json'}
    auth_token = authenticate()
    payload = {
        'jsonrpc': '2.0',
        'method': 'item.get',
        'params': {
            'output': 'extend',
            'hostids': host_id,
            'search': {'key_': 'State of service'}
        },
        'auth': auth_token,
        'id': 1
    }
    response = requests.post(zabbix_url, data=json.dumps(payload), headers=headers)
    result = response.json()
    return result['result']

# Get item status for a specific item
def get_item_status(item_id):
    headers = {'Content-Type': 'application/json'}
    auth_token = authenticate()
    payload = {
        'jsonrpc': '2.0',
        'method': 'history.get',
        'params': {
            'output': 'extend',
            'history': 0,
            'itemids': item_id,
            'sortfield': 'clock',
            'sortorder': 'DESC',
            'limit': 1
        },
        'auth': auth_token,
        'id': 1
    }
    response = requests.post(zabbix_url, data=json.dumps(payload), headers=headers)
    result = response.json()
    return result['result'][0]['value']

# Create Excel workbook and sheets
def create_excel(host_names, items):
    workbook = Workbook()

    for host_name in host_names:
        worksheet = workbook.create_sheet(title=host_name)

        # Add headers
        headers = ['Item Name', 'Item Status']
        worksheet.append(headers)

        # Get items and their status for the host
        host_id = get_host_ids(host_name)[0]
        host_items = get_items(host_id)

        for item in host_items:
            item_name = item['name']
            item_id = item['itemid']
            item_status = get_item_status(item_id)

            worksheet.append([item_name, item_status])

    # Remove default sheet created by openpyxl
    workbook.remove(workbook['Sheet'])
    
    # Save the workbook to a file
    workbook.save('zabbix_data.xlsx')

if __name__ == "__main__":
    # Replace 'Your Host Group Name' with the actual host group name
    host_group_name = 'Your Host Group Name'
    
    # Get host names in the specified host group
    host_names = get_host_ids(host_group_name)

    # Create Excel workbook and sheets
    create_excel(host_names, items)
