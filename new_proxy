import requests
import json
from datetime import datetime, timedelta
from openpyxl import Workbook

# Zabbix API details
zabbix_url = 'http://your-zabbix-server/zabbix/api_jsonrpc.php'
zabbix_user = 'your-username'
zabbix_password = 'your-password'

# Host group name
host_group_name = 'Your Host Group Name'

# Zabbix API authentication
headers = {'Content-Type': 'application/json'}
auth_payload = {
    'jsonrpc': '2.0',
    'method': 'user.login',
    'params': {
        'user': zabbix_user,
        'password': zabbix_password,
    },
    'id': 1,
}
auth_response = requests.post(zabbix_url, data=json.dumps(auth_payload), headers=headers)
auth_result = auth_response.json()

if 'result' in auth_result:
    auth_token = auth_result['result']
else:
    print("Failed to authenticate.")
    exit()

# Get hosts in the specified host group
get_hosts_payload = {
    'jsonrpc': '2.0',
    'method': 'hostgroup.get',
    'params': {
        'output': ['groupid'],
        'select_hosts': ['hostid', 'host'],
        'filter': {
            'name': [host_group_name],
        }
    },
    'auth': auth_token,
    'id': 1,
}

get_hosts_response = requests.post(zabbix_url, data=json.dumps(get_hosts_payload), headers=headers)
get_hosts_result = get_hosts_response.json()

if 'result' in get_hosts_result:
    hosts = get_hosts_result['result'][0]['hosts']
else:
    print("Failed to get hosts in the specified group.")
    exit()

# Initialize Excel workbook and sheet
workbook = Workbook()
sheet = workbook.active

# Write headers to the sheet
headers = ['Host', 'CPU (%)', 'Memory (%)', 'Queue', 'Uptime (days)', 'Last Seen (seconds ago)']
sheet.append(headers)

# Function to convert seconds to days
def seconds_to_days(seconds):
    return seconds / (24 * 3600)

# Function to calculate Last Seen in seconds
def calculate_last_seen(last_seen):
    current_time = datetime.now()
    last_seen_time = datetime.fromtimestamp(last_seen)
    return (current_time - last_seen_time).total_seconds()

# Iterate through hosts and fetch data
for host in hosts:
    host_id = host['hostid']
    host_name = host['host']

    # Fetch item values for each host
    get_items_payload = {
        'jsonrpc': '2.0',
        'method': 'item.get',
        'params': {
            'output': ['key_', 'lastvalue'],
            'hostids': host_id,
            'search': {
                'key_': ['system.cpu.util', 'vm.memory.utilization', 'zabbix[queue,10m]', 'system.uptime', 'zabbix[proxy,{},lastaccess'.format(host_name)]
            }
        },
        'auth': auth_token,
        'id': 1,
    }

    get_items_response = requests.post(zabbix_url, data=json.dumps(get_items_payload), headers=headers)
    get_items_result = get_items_response.json()

    if 'result' in get_items_result:
        data_row = [host_name]
        for item in get_items_result['result']:
            key = item['key_']
            last_value = float(item['lastvalue'])

            if 'cpu' in key:
                data_row.append(f"{last_value:.2f}")
            elif 'memory' in key:
                data_row.append(f"{last_value:.2f}")
            elif 'queue' in key:
                data_row.append(last_value)
            elif 'uptime' in key:
                uptime_days = seconds_to_days(last_value)
                data_row.append(f"{uptime_days:.2f}")
            elif 'lastaccess' in key:
                last_seen_seconds_ago = calculate_last_seen(last_value)
                data_row.append(int(last_seen_seconds_ago))

        sheet.append(data_row)

# Save the workbook to a file
workbook.save('zabbix_data.xlsx')
print("Data exported to zabbix_data.xlsx")
