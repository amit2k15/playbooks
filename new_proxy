import time
from datetime import datetime, timedelta
from pyzabbix import ZabbixAPI
from openpyxl import Workbook

# Zabbix server configuration
zabbix_server = 'http://your_zabbix_server_url'
zabbix_user = 'your_zabbix_username'
zabbix_password = 'your_zabbix_password'

# Host group and item names
host_group_name = 'YourHostGroupName'
item_names = {
    'CPU': 'system.cpu.util',
    'Memory': 'vm.memory.utilization',
    'Queue': 'zabbix[queue,10m]',
    'Uptime': 'system.uptime',
    'LastSeen': 'zabbix[proxy,{HOST.HOST},lastaccess]'
}

# Connect to Zabbix API
zapi = ZabbixAPI(zabbix_server)
zapi.login(zabbix_user, zabbix_password)

# Get hosts in the specified host group
hostgroup = zapi.hostgroup.get(filter={'name': host_group_name}, selectHosts=['hostid', 'host'])
hosts = hostgroup[0]['hosts']

# Create Excel workbook and sheet
workbook = Workbook()
sheet = workbook.active

# Write header
header = ['Host'] + list(item_names.keys())
sheet.append(header)

# Fetch data for each host
for host in hosts:
    host_id = host['hostid']
    host_name = host['host']

    # Fetch item values for the host
    item_values = {}
    for item_key, item_name in item_names.items():
        item = zapi.item.get(hostids=host_id, filter={'key_': item_name}, output=['lastvalue'])
        item_values[item_key] = item[0]['lastvalue']

    # Calculate Last Seen in seconds
    last_seen_timestamp = int(item_values['LastSeen'])
    current_time = int(time.time())
    last_seen_seconds = current_time - last_seen_timestamp

    # Calculate Uptime in days
    uptime_seconds = int(item_values['Uptime'])
    uptime_days = uptime_seconds / (24 * 3600)

    # Format CPU and Memory values to two decimal places
    item_values['CPU'] = f'{float(item_values["CPU"]):.2f}'
    item_values['Memory'] = f'{float(item_values["Memory"]):.2f}'

    # Write data to Excel sheet
    row_data = [host_name] + list(item_values.values())
    sheet.append(row_data)

# Save the Excel file
output_file = f'{host_group_name}_data.xlsx'
workbook.save(output_file)
print(f'Data has been saved to {output_file}')

# Logout from Zabbix API
zapi.user.logout()
