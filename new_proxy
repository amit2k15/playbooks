import requests
from datetime import datetime, timedelta
import pandas as pd

# Zabbix API settings
zabbix_api_url = 'http://your_zabbix_server/zabbix/api_jsonrpc.php'
zabbix_user = 'your_username'
zabbix_password = 'your_password'

# Host group and items
host_group = 'YourHostGroup'
cpu_item = 'system.cpu.util'
memory_item = 'vm.memory.utilization'
queue_item = 'zabbix[queue,10m]'
uptime_item = 'system.uptime'
last_seen_item = 'zabbix[proxy,{HOST.HOST},lastaccess'

# Zabbix API authentication
auth_data = {
    'jsonrpc': '2.0',
    'method': 'user.login',
    'params': {
        'user': zabbix_user,
        'password': zabbix_password
    },
    'id': 1
}

response = requests.post(zabbix_api_url, json=auth_data)
auth_result = response.json()
auth_token = auth_result.get('result')

# Get hosts in the specified host group
host_data = {
    'jsonrpc': '2.0',
    'method': 'host.get',
    'params': {
        'output': ['hostid', 'name'],
        'groupids': [host_group],
        'selectInterfaces': ['interfaceid', 'ip']
    },
    'auth': auth_token,
    'id': 2
}

response = requests.post(zabbix_api_url, json=host_data)
hosts = response.json()['result']

# Prepare data for export
data = {'Host': [], 'CPU (%)': [], 'Memory (%)': [], 'Queue': [], 'Uptime (days)': [], 'Last Seen (seconds)': []}

for host in hosts:
    host_id = host['hostid']
    host_name = host['name']

    # Get item values
    def get_item_value(item_key):
        item_data = {
            'jsonrpc': '2.0',
            'method': 'item.get',
            'params': {
                'output': ['lastvalue'],
                'hostids': host_id,
                'search': {'key_': item_key}
            },
            'auth': auth_token,
            'id': 3
        }
        response = requests.post(zabbix_api_url, json=item_data)
        return response.json()['result'][0]['lastvalue']

    cpu_value = get_item_value(cpu_item)
    memory_value = get_item_value(memory_item)
    queue_value = get_item_value(queue_item)
    uptime_value_seconds = float(get_item_value(uptime_item))
    last_seen_value_seconds = float(get_item_value(last_seen_item))

    # Calculate Uptime in days
    uptime_days = round(uptime_value_seconds / (24 * 3600), 2)

    # Calculate Last Seen in seconds
    current_time_seconds = datetime.now().timestamp()
    last_seen_seconds = current_time_seconds - last_seen_value_seconds

    # Add data to the dictionary
    data['Host'].append(host_name)
    data['CPU (%)'].append(round(float(cpu_value), 2))
    data['Memory (%)'].append(round(float(memory_value), 2))
    data['Queue'].append(queue_value)
    data['Uptime (days)'].append(uptime_days)
    data['Last Seen (seconds)'].append(last_seen_seconds)

# Create a DataFrame from the data
df = pd.DataFrame(data)

# Export data to Excel
excel_file = 'zabbix_data.xlsx'
df.to_excel(excel_file, index=False)
print(f'Data exported to {excel_file}')

# Logout from Zabbix API
logout_data = {
    'jsonrpc': '2.0',
    'method': 'user.logout',
    'params': [],
    'auth': auth_token,
    'id': 4
}

requests.post(zabbix_api_url, json=logout_data)
