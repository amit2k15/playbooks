import openpyxl
from datetime import datetime, timedelta
from zabbix_api import ZabbixAPI

# Zabbix server information
zabbix_server = 'http://your-zabbix-server.com/zabbix'
zabbix_user = 'your-username'
zabbix_password = 'your-password'

# Host group name
host_group_name = 'YourHostGroupName'

# Connect to Zabbix API
zabbix = ZabbixAPI(zabbix_server)
zabbix.login(zabbix_user, zabbix_password)

# Get host group ID
host_group = zabbix.hostgroup.get(filter={'name': host_group_name})
host_group_id = host_group[0]['groupid']

# Get hosts in the specified host group
hosts = zabbix.host.get(groupids=host_group_id, output=['hostid', 'host'])

# Create Excel workbook and worksheet
workbook = openpyxl.Workbook()
worksheet = workbook.active
worksheet.append(['Host', 'CPU Utilization (%)', 'Memory Utilization (%)', 'Queue', 'Uptime (days)', 'Last Seen (seconds)'])

# Iterate through hosts
for host in hosts:
    host_id = host['hostid']
    host_name = host['host']

    # Get CPU Utilization
    cpu_util = zabbix.item.get(hostids=host_id, search={'key_': 'system.cpu.util'}, output=['lastvalue'])[0]['lastvalue']
    cpu_util = round(float(cpu_util), 2) if cpu_util else None

    # Get Memory Utilization
    memory_util = zabbix.item.get(hostids=host_id, search={'key_': 'vm.memory.utilization'}, output=['lastvalue'])[0]['lastvalue']
    memory_util = round(float(memory_util), 2) if memory_util else None

    # Get Queue
    queue = zabbix.item.get(hostids=host_id, search={'key_': 'zabbix[queue,10m]'}, output=['lastvalue'])[0]['lastvalue']

    # Get Uptime
    uptime_seconds = zabbix.item.get(hostids=host_id, search={'key_': 'system.uptime'}, output=['lastvalue'])[0]['lastvalue']
    uptime_days = round(float(uptime_seconds) / (24 * 60 * 60), 2) if uptime_seconds else None

    # Get Last Seen
    last_seen_seconds = zabbix.item.get(hostids=host_id, search={'key_': 'zabbix[proxy,{HOST.HOST},lastaccess]'}, output=['lastvalue'])[0]['lastvalue']
    last_seen_seconds = float(last_seen_seconds) if last_seen_seconds else None

    # Calculate Last Seen in seconds
    current_time_seconds = datetime.now().timestamp()
    last_seen_difference = current_time_seconds - last_seen_seconds if last_seen_seconds else None

    # Append data to the worksheet
    worksheet.append([host_name, cpu_util, memory_util, queue, uptime_days, last_seen_difference])

# Save Excel file
excel_filename = f'{host_group_name}_report.xlsx'
workbook.save(excel_filename)
print(f'Data has been saved to {excel_filename}')

# Logout from Zabbix API
zabbix.user.logout()
